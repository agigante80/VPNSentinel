---
# =============================================================================
# VPN Sentinel CI/CD Pipeline - Comprehensive & Modernized
# =============================================================================
# This workflow provides complete CI/CD automation with:
# - Auto-detection of project type and structure
# - Modular job architecture for maintainability
# - Docker Hub + GHCR publishing
# - Security scanning with SARIF reporting
# - Automated versioning and releases
# - Docker description validation and updates
# - Parallel execution for speed
# - Manual and automatic triggers
# =============================================================================

name: VPN Sentinel CI/CD v2

# -----------------------------------------------------------------------------
# Permissions: Minimal required for security
# -----------------------------------------------------------------------------
permissions:
  contents: write        # For creating releases and tags
  packages: write        # For publishing to GHCR
  security-events: write # For uploading SARIF reports
  actions: read          # For workflow artifacts

# -----------------------------------------------------------------------------
# Triggers: Automatic (push/PR) and Manual (workflow_dispatch)
# -----------------------------------------------------------------------------
on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (major, minor, patch)'
        required: false
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        default: false
        type: boolean
      custom_tag:
        description: 'Custom Docker tag (optional)'
        required: false
        type: string

# -----------------------------------------------------------------------------
# Environment Variables: Global configuration
# -----------------------------------------------------------------------------
env:
  PYTHON_VERSION: '3.12'
  DOCKER_BUILDKIT: '1'
  COMPOSE_DOCKER_CLI_BUILD: '1'
  REGISTRY_DOCKERHUB: docker.io
  REGISTRY_GHCR: ghcr.io
  IMAGE_NAME_SERVER: vpn-sentinel-server
  IMAGE_NAME_CLIENT: vpn-sentinel-client

# =============================================================================
# JOBS: Modular pipeline stages
# =============================================================================

jobs:

  # ---------------------------------------------------------------------------
  # Stage 1: PROJECT DETECTION
  # Auto-detect project type, language, and structure
  # ---------------------------------------------------------------------------
  detect-project:
    name: ðŸ” Detect Project Type
    runs-on: ubuntu-latest
    outputs:
      has_python: ${{ steps.detect.outputs.has_python }}
      has_nodejs: ${{ steps.detect.outputs.has_nodejs }}
      has_docker: ${{ steps.detect.outputs.has_docker }}
      has_tests: ${{ steps.detect.outputs.has_tests }}
      python_version: ${{ steps.detect.outputs.python_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect project structure
        id: detect
        run: |
          echo "ðŸ” Analyzing project structure..."
          
          # Python detection
          if [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
            echo "has_python=true" >> $GITHUB_OUTPUT
            echo "âœ… Python project detected"
          else
            echo "has_python=false" >> $GITHUB_OUTPUT
          fi
          
          # Node.js detection
          if [ -f "package.json" ]; then
            echo "has_nodejs=true" >> $GITHUB_OUTPUT
            echo "âœ… Node.js project detected"
          else
            echo "has_nodejs=false" >> $GITHUB_OUTPUT
          fi
          
          # Docker detection
          if [ -f "Dockerfile" ] || [ -f "docker-compose.yml" ] || [ -f "compose.yaml" ]; then
            echo "has_docker=true" >> $GITHUB_OUTPUT
            echo "âœ… Docker project detected"
          else
            echo "has_docker=false" >> $GITHUB_OUTPUT
          fi
          
          # Tests detection
          if [ -d "tests" ] || [ -d "test" ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "âœ… Tests directory found"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi
          
          # Python version detection
          if [ -f ".python-version" ]; then
            echo "python_version=$(cat .python-version)" >> $GITHUB_OUTPUT
          else
            echo "python_version=${{ env.PYTHON_VERSION }}" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… Project detection complete"

  # ---------------------------------------------------------------------------
  # Stage 2: LINT
  # Static analysis, code formatting, and style checks
  # ---------------------------------------------------------------------------
  lint:
    name: ðŸ” Lint & Style Check
    runs-on: ubuntu-latest
    needs: detect-project
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        if: needs.detect-project.outputs.has_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.detect-project.outputs.python_version }}
          cache: 'pip'

      - name: Install Python linting tools
        if: needs.detect-project.outputs.has_python == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black pylint mypy

      - name: Run Python syntax check
        if: needs.detect-project.outputs.has_python == 'true'
        run: |
          echo "ðŸ Checking Python syntax..."
          find . -name "*.py" -not -path "*/\.*" | while read file; do
            python -m py_compile "$file" || exit 1
          done
          echo "âœ… Python syntax check passed"

      - name: Run flake8
        if: needs.detect-project.outputs.has_python == 'true'
        run: |
          echo "ðŸ” Running flake8..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check shell scripts (ShellCheck)
        run: |
          echo "ðŸš Installing ShellCheck..."
          sudo apt-get update -y
          sudo apt-get install -y shellcheck
          
          echo "ðŸ” Finding shell scripts..."
          files=$(find . -name "*.sh" -not -path "*/\.*" -not -path "*/node_modules/*" | tr '\n' ' ')
          
          if [ -n "$files" ]; then
            echo "Running ShellCheck on: $files"
            shellcheck -x --severity=warning $files || true
            shellcheck -x --severity=error $files || exit 1
            echo "âœ… ShellCheck passed"
          else
            echo "â„¹ï¸ No shell scripts found"
          fi

      - name: Check shell script formatting (shfmt)
        run: |
          echo "ðŸ” Checking shell script formatting..."
          files=$(find . -name "*.sh" -not -path "*/\.*" -not -path "*/node_modules/*" | tr '\n' ' ')
          
          if [ -n "$files" ]; then
            docker run --rm -v "$PWD":/workdir -w /workdir mvdan/shfmt:latest -l $files
            echo "âœ… Shell formatting check passed"
          else
            echo "â„¹ï¸ No shell scripts found"
          fi

      - name: Validate Docker Compose files
        if: needs.detect-project.outputs.has_docker == 'true'
        run: |
          echo "ðŸ³ Validating Docker Compose files..."
          
          for file in $(find . -name "compose.yaml" -o -name "docker-compose.yml" -not -path "*/\.*"); do
            echo "Checking: $file"
            docker compose -f "$file" config > /dev/null
            echo "âœ… $file is valid"
          done

  # ---------------------------------------------------------------------------
  # Stage 3: UNIT TESTS
  # Execute unit tests with coverage
  # ---------------------------------------------------------------------------
  test:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [detect-project, lint]
    if: |
      needs.detect-project.outputs.has_tests == 'true' &&
      github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.detect-project.outputs.python_version }}
          cache: 'pip'

      - name: Cache test dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            tests/__pycache__
          key: ${{ runner.os }}-test-${{ hashFiles('tests/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-test-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f tests/requirements.txt ]; then
            pip install -r tests/requirements.txt
          fi
          pip install -e .
          pip install pytest pytest-cov coverage

      - name: Run unit tests with coverage
        run: |
          cd tests
          pytest unit/ -v \
            --tb=short \
            --junitxml=unit-test-results.xml \
            --cov=../vpn-sentinel-server \
            --cov=../vpn-sentinel-client \
            --cov=../vpn_sentinel_common \
            --cov-report=xml:coverage.xml \
            --cov-report=html:coverage_html \
            --cov-report=term-missing

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results
          path: |
            tests/unit-test-results.xml
            tests/coverage.xml
            tests/coverage_html/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: tests/coverage.xml
          flags: unittests
          name: codecov-vpn-sentinel
          fail_ci_if_error: false

  # ---------------------------------------------------------------------------
  # Stage 4: INTEGRATION TESTS
  # Test component interactions
  # ---------------------------------------------------------------------------
  integration-test:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [detect-project, test]
    if: |
      needs.detect-project.outputs.has_tests == 'true' &&
      github.event.inputs.skip_tests != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.detect-project.outputs.python_version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
          pip install -e .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true

      - name: Build test containers
        run: |
          echo "ðŸ³ Building test containers..."
          docker compose -f tests/docker-compose.test.yaml build --no-cache

      - name: Start test environment
        run: |
          docker compose -f tests/docker-compose.test.yaml up -d
          
          echo "â³ Waiting for services to be ready..."
          HOST_PORT=$(docker compose -f tests/docker-compose.test.yaml port vpn-sentinel-server-test 5001 | sed 's/.*://')
          
          timeout 300s bash -c "until curl -sSf http://localhost:${HOST_PORT}/health >/dev/null; do sleep 2; done"
          echo "âœ… Test environment ready"

      - name: Run integration tests
        run: |
          cd tests
          export VPN_SENTINEL_URL=http://localhost:5000
          export VPN_SENTINEL_API_PATH=/test/v1
          export VPN_SENTINEL_API_KEY=test-api-key
          pytest integration/ -v --tb=short

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Server Logs ==="
          docker compose -f tests/docker-compose.test.yaml logs vpn-sentinel-server-test
          echo "=== Client Logs ==="
          docker compose -f tests/docker-compose.test.yaml logs vpn-sentinel-client-test

      - name: Cleanup
        if: always()
        run: |
          docker compose -f tests/docker-compose.test.yaml down -v

  # ---------------------------------------------------------------------------
  # Stage 5: BUILD
  # Compile/bundle application code
  # ---------------------------------------------------------------------------
  build:
    name: ðŸ—ï¸ Build Application
    runs-on: ubuntu-latest
    needs: [detect-project, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        if: needs.detect-project.outputs.has_python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ needs.detect-project.outputs.python_version }}

      - name: Build Python package
        if: needs.detect-project.outputs.has_python == 'true'
        run: |
          echo "ðŸ“¦ Building Python package..."
          python -m pip install --upgrade pip build
          pip install -e .
          echo "âœ… Build complete"

      - name: Get version info
        id: version
        run: |
          if [ -f "get_version.sh" ]; then
            VERSION=$(bash get_version.sh)
          else
            VERSION="1.0.0-dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version: $VERSION"

      - name: Create build artifact
        run: |
          mkdir -p build-artifacts
          echo "${{ steps.version.outputs.version }}" > build-artifacts/version.txt
          echo "âœ… Build artifacts created"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts/

  # ---------------------------------------------------------------------------
  # Stage 6: VALIDATE SHORT DESCRIPTION
  # Ensure Docker Hub short descriptions are â‰¤100 characters
  # ---------------------------------------------------------------------------
  validate-short-description:
    name: ðŸ“ Validate Docker Descriptions
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate server short description
        run: |
          echo "ðŸ“ Validating server short description..."
          
          if [ -f "dockerhub/server_docker-repository-short.txt" ]; then
            DESC=$(cat dockerhub/server_docker-repository-short.txt | tr -d '\n')
            LENGTH=${#DESC}
            echo "Server description length: $LENGTH characters"
            
            if [ $LENGTH -gt 100 ]; then
              echo "âŒ ERROR: Server short description exceeds 100 characters ($LENGTH)"
              echo "Description: $DESC"
              exit 1
            fi
            echo "âœ… Server short description is valid ($LENGTH/100 chars)"
          else
            echo "âš ï¸ Warning: Server short description file not found"
          fi

      - name: Validate client short description
        run: |
          echo "ðŸ“ Validating client short description..."
          
          if [ -f "dockerhub/client_docker-repository-short.txt" ]; then
            DESC=$(cat dockerhub/client_docker-repository-short.txt | tr -d '\n')
            LENGTH=${#DESC}
            echo "Client description length: $LENGTH characters"
            
            if [ $LENGTH -gt 100 ]; then
              echo "âŒ ERROR: Client short description exceeds 100 characters ($LENGTH)"
              echo "Description: $DESC"
              exit 1
            fi
            echo "âœ… Client short description is valid ($LENGTH/100 chars)"
          else
            echo "âš ï¸ Warning: Client short description file not found"
          fi

      - name: Validate long descriptions
        run: |
          echo "ðŸ“ Checking long descriptions..."
          
          for file in dockerhub/*_docker-repository-overview.md; do
            if [ -f "$file" ]; then
              if grep -q "github.com" "$file"; then
                echo "âœ… $(basename $file) contains GitHub link"
              else
                echo "âš ï¸ Warning: $(basename $file) missing GitHub repository link"
              fi
            fi
          done

  # ---------------------------------------------------------------------------
  # Stage 7: DOCKER TEST BUILD
  # Build Docker images locally without pushing (validation)
  # ---------------------------------------------------------------------------
  docker-test:
    name: ðŸ³ Docker Test Build
    runs-on: ubuntu-latest
    needs: [validate-short-description, test]
    if: needs.detect-project.outputs.has_docker == 'true'
    strategy:
      matrix:
        component: [server, client]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get version
        id: version
        run: |
          if [ -f "get_version.sh" ]; then
            VERSION=$(bash get_version.sh)
          else
            VERSION="test"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build Docker image (test)
        run: |
          echo "ðŸ³ Building vpn-sentinel-${{ matrix.component }}:test..."
          
          docker build \
            --tag vpn-sentinel-${{ matrix.component }}:test \
            --file vpn-sentinel-${{ matrix.component }}/Dockerfile \
            --build-arg VERSION=${{ steps.version.outputs.version }} \
            --build-arg COMMIT_HASH=${{ steps.version.outputs.short_sha }} \
            .
          
          echo "âœ… Build successful"

      - name: Show image size
        run: |
          SIZE=$(docker images vpn-sentinel-${{ matrix.component }}:test --format "{{.Size}}")
          echo "ðŸ“¦ Image size: $SIZE"
          echo "IMAGE_SIZE_${{ matrix.component }}=$SIZE" >> $GITHUB_ENV

      - name: Test server container startup
        if: matrix.component == 'server'
        run: |
          echo "ðŸ§ª Testing server container..."
          docker run -d --name test-server \
            -e VPN_SENTINEL_API_KEY=test-key \
            -e VPN_SENTINEL_SERVER_API_PORT=5000 \
            -e VPN_SENTINEL_SERVER_HEALTH_PORT=8081 \
            -e VPN_SENTINEL_SERVER_DASHBOARD_PORT=8080 \
            -e VPN_SENTINEL_SERVER_DASHBOARD_ENABLED=false \
            -e TELEGRAM_BOT_TOKEN=test:token \
            -e TELEGRAM_CHAT_ID=123456789 \
            vpn-sentinel-${{ matrix.component }}:test
          
          sleep 10
          
          if docker ps | grep test-server; then
            echo "âœ… Server container running"
            docker logs test-server | tail -20
            docker stop test-server
            docker rm test-server
          else
            echo "âŒ Server container failed"
            docker logs test-server
            docker rm test-server
            exit 1
          fi

      - name: Test client container startup
        if: matrix.component == 'client'
        run: |
          echo "ðŸ§ª Testing client container..."
          docker run --rm vpn-sentinel-${{ matrix.component }}:test --version || echo "âœ… Client image ready"

  # ---------------------------------------------------------------------------
  # Stage 8: DOCKER PUBLISH
  # Build and push images to Docker Hub and GHCR
  # ---------------------------------------------------------------------------
  docker-publish:
    name: ðŸš€ Docker Publish
    runs-on: ubuntu-latest
    needs: [docker-test, integration-test]
    if: |
      (github.ref == 'refs/heads/main' || 
       github.ref == 'refs/heads/develop' || 
       startsWith(github.ref, 'refs/tags/v')) &&
      github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        component: [server, client]
    outputs:
      server_tags: ${{ steps.meta-server.outputs.tags }}
      client_tags: ${{ steps.meta-client.outputs.tags }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_DOCKERHUB }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY_GHCR }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version and metadata
        id: version
        run: |
          if [ -f "get_version.sh" ]; then
            VERSION=$(bash get_version.sh)
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version: $VERSION"

      - name: Determine tags
        id: tags
        run: |
          COMPONENT=${{ matrix.component }}
          VERSION=${{ steps.version.outputs.version }}
          SHORT_SHA=${{ steps.version.outputs.short_sha }}
          
          # Custom tag from workflow input
          CUSTOM_TAG="${{ github.event.inputs.custom_tag }}"
          
          # Base image names
          DOCKERHUB_IMAGE="agigante80/vpn-sentinel-${COMPONENT}"
          GHCR_IMAGE="ghcr.io/${{ github.repository_owner }}/vpn-sentinel-${COMPONENT}"
          
          # Determine tags based on branch/tag
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            TAGS="${DOCKERHUB_IMAGE}:latest,${DOCKERHUB_IMAGE}:${VERSION},${DOCKERHUB_IMAGE}:latest-${SHORT_SHA}"
            TAGS="${TAGS},${GHCR_IMAGE}:latest,${GHCR_IMAGE}:${VERSION},${GHCR_IMAGE}:latest-${SHORT_SHA}"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            TAGS="${DOCKERHUB_IMAGE}:development,${DOCKERHUB_IMAGE}:development-${SHORT_SHA}"
            TAGS="${TAGS},${GHCR_IMAGE}:development,${GHCR_IMAGE}:development-${SHORT_SHA}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG_VERSION=${GITHUB_REF#refs/tags/v}
            TAGS="${DOCKERHUB_IMAGE}:${TAG_VERSION},${DOCKERHUB_IMAGE}:latest"
            TAGS="${TAGS},${GHCR_IMAGE}:${TAG_VERSION},${GHCR_IMAGE}:latest"
          fi
          
          # Add custom tag if provided
          if [ -n "$CUSTOM_TAG" ]; then
            TAGS="${TAGS},${DOCKERHUB_IMAGE}:${CUSTOM_TAG},${GHCR_IMAGE}:${CUSTOM_TAG}"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Tags: $TAGS"

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            agigante80/vpn-sentinel-${{ matrix.component }}
            ghcr.io/${{ github.repository_owner }}/vpn-sentinel-${{ matrix.component }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=development,enable=${{ github.ref == 'refs/heads/develop' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: vpn-sentinel-${{ matrix.component }}/Dockerfile
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ steps.version.outputs.version }}
            COMMIT_HASH=${{ steps.version.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Save image info
        run: |
          mkdir -p image-info
          echo "${{ steps.tags.outputs.tags }}" > image-info/${{ matrix.component }}-tags.txt
          echo "${{ steps.version.outputs.version }}" > image-info/version.txt

      - name: Upload image info
        uses: actions/upload-artifact@v4
        with:
          name: image-info-${{ matrix.component }}
          path: image-info/

  # ---------------------------------------------------------------------------
  # Stage 9: UPDATE DOCKER HUB DESCRIPTIONS
  # Update repository descriptions via Docker Hub API
  # ---------------------------------------------------------------------------
  update-dockerhub-descriptions:
    name: ðŸ“ Update Docker Hub Descriptions
    runs-on: ubuntu-latest
    needs: docker-publish
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        component: [server, client]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Docker Hub description
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "ðŸ“ Updating Docker Hub description for ${{ matrix.component }}..."
          
          if [ -f "scripts/update_dockerhub_description.sh" ]; then
            chmod +x scripts/update_dockerhub_description.sh
            ./scripts/update_dockerhub_description.sh \
              "$DOCKERHUB_USERNAME" \
              "$DOCKERHUB_TOKEN" \
              "agigante80/vpn-sentinel-${{ matrix.component }}" \
              "dockerhub/${{ matrix.component }}_docker-repository-overview.md"
            echo "âœ… Docker Hub description updated"
          else
            echo "âš ï¸ Update script not found, skipping"
          fi

  # ---------------------------------------------------------------------------
  # Stage 10: SECURITY SCAN
  # Scan for vulnerabilities and upload SARIF reports
  # ---------------------------------------------------------------------------
  security-scan:
    name: ðŸ” Security Scan
    runs-on: ubuntu-latest
    needs: docker-publish
    permissions:
      security-events: write
      actions: read
      contents: read
    strategy:
      matrix:
        component: [server, client]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download image info
        uses: actions/download-artifact@v4
        with:
          name: image-info-${{ matrix.component }}
          path: image-info/

      - name: Get image tag
        id: image
        run: |
          TAGS=$(cat image-info/${{ matrix.component }}-tags.txt)
          FIRST_TAG=$(echo "$TAGS" | cut -d',' -f1)
          echo "tag=$FIRST_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Scanning: $FIRST_TAG"

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-${{ matrix.component }}.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy filesystem scan to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-${{ matrix.component }}.sarif'
          category: 'trivy-fs-${{ matrix.component }}'

      - name: Run Trivy vulnerability scanner (image)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: 'image'
          image-ref: ${{ steps.image.outputs.tag }}
          format: 'sarif'
          output: 'trivy-image-${{ matrix.component }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy image scan to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-image-${{ matrix.component }}.sarif'
          category: 'trivy-image-${{ matrix.component }}'

      - name: Run Python dependency check
        if: matrix.component == 'server'
        run: |
          pip install safety
          safety check --json || true
          echo "âœ… Dependency scan complete"

  # ---------------------------------------------------------------------------
  # Stage 11: DEPLOYMENT TEST
  # Validate deployment configurations
  # ---------------------------------------------------------------------------
  deployment-test:
    name: ðŸš€ Deployment Validation
    runs-on: ubuntu-latest
    needs: [docker-publish, build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate deployment configurations
        run: |
          echo "ðŸš€ Validating deployment configurations..."
          
          DEPLOYMENTS=("server-central" "all-in-one" "client-with-vpn" "client-standalone")
          
          for deployment in "${DEPLOYMENTS[@]}"; do
            echo "Testing: $deployment"
            DEPLOY_PATH="deployments/$deployment"
            
            if [ -d "$DEPLOY_PATH" ]; then
              if [ -f "$DEPLOY_PATH/compose.yaml" ]; then
                docker compose -f "$DEPLOY_PATH/compose.yaml" config > /dev/null
                echo "âœ… $deployment configuration valid"
              else
                echo "âš ï¸ $deployment missing compose.yaml"
              fi
            else
              echo "âš ï¸ $deployment directory not found"
            fi
          done
          
          echo "âœ… Deployment validation complete"

      - name: Test main compose file
        run: |
          if [ -f "compose.yaml" ]; then
            docker compose -f compose.yaml config > /dev/null
            echo "âœ… Main compose.yaml is valid"
          fi

  # ---------------------------------------------------------------------------
  # Stage 12: RELEASE
  # Create GitHub release with semantic versioning
  # ---------------------------------------------------------------------------
  release:
    name: ðŸ·ï¸ Create Release
    runs-on: ubuntu-latest
    needs: [docker-publish, deployment-test, security-scan]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Download all image info
        uses: actions/download-artifact@v4
        with:
          pattern: image-info-*
          merge-multiple: true
          path: image-info/

      - name: Get version
        id: version
        run: |
          if [ -f "get_version.sh" ]; then
            VERSION=$(bash get_version.sh)
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Version: $VERSION"

      - name: Check if tag exists
        id: check-tag
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Tag $TAG already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ¨ Tag $TAG will be created"
          fi

      - name: Create and push tag
        if: steps.check-tag.outputs.exists == 'false'
        env:
          ACTIONS_PUSH_TOKEN: ${{ secrets.ACTIONS_PUSH_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git tag -a "$TAG" -m "Release $TAG"
          git push "https://x-access-token:${ACTIONS_PUSH_TOKEN}@github.com/${{ github.repository }}" "$TAG"
          
          echo "âœ… Tag $TAG created and pushed"

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          # Get image tags
          if [ -f "image-info/server-tags.txt" ]; then
            SERVER_TAGS=$(cat image-info/server-tags.txt | head -1)
          else
            SERVER_TAGS="agigante80/vpn-sentinel-server:latest"
          fi
          
          if [ -f "image-info/client-tags.txt" ]; then
            CLIENT_TAGS=$(cat image-info/client-tags.txt | head -1)
          else
            CLIENT_TAGS="agigante80/vpn-sentinel-client:latest"
          fi
          
          # Generate release notes
          cat > release-notes.md << EOF
          # VPN Sentinel v${VERSION}
          
          ## ðŸš€ What's New
          
          This release includes the latest updates and improvements to VPN Sentinel.
          
          ## ðŸ³ Docker Images
          
          ### Server
          - **Docker Hub**: \`${SERVER_TAGS}\`
          - **GHCR**: \`ghcr.io/${{ github.repository_owner }}/vpn-sentinel-server:${VERSION}\`
          
          ### Client
          - **Docker Hub**: \`${CLIENT_TAGS}\`
          - **GHCR**: \`ghcr.io/${{ github.repository_owner }}/vpn-sentinel-client:${VERSION}\`
          
          ## ðŸ“¦ Installation
          
          \`\`\`bash
          # Pull images from Docker Hub
          docker pull agigante80/vpn-sentinel-server:${VERSION}
          docker pull agigante80/vpn-sentinel-client:${VERSION}
          
          # Or from GHCR
          docker pull ghcr.io/${{ github.repository_owner }}/vpn-sentinel-server:${VERSION}
          docker pull ghcr.io/${{ github.repository_owner }}/vpn-sentinel-client:${VERSION}
          \`\`\`
          
          ## ðŸ”— Links
          
          - [Docker Hub - Server](https://hub.docker.com/r/agigante80/vpn-sentinel-server)
          - [Docker Hub - Client](https://hub.docker.com/r/agigante80/vpn-sentinel-client)
          - [GitHub Repository](https://github.com/${{ github.repository }})
          - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          ## ðŸ“ Commit
          
          - SHA: \`${SHORT_SHA}\`
          - Branch: \`main\`
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${VERSION}...main
          EOF
          
          echo "Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: steps.check-tag.outputs.exists == 'false'
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Release ${{ steps.version.outputs.tag }}
          body_path: release-notes.md
          draft: false
          prerelease: false
          token: ${{ secrets.ACTIONS_PUSH_TOKEN || secrets.GITHUB_TOKEN }}

  # ---------------------------------------------------------------------------
  # Stage 13: WORKFLOW SUMMARY
  # Generate comprehensive summary
  # ---------------------------------------------------------------------------
  workflow-summary:
    name: ðŸ“Š Workflow Summary
    runs-on: ubuntu-latest
    needs: [lint, test, integration-test, build, validate-short-description, docker-test, docker-publish, security-scan, deployment-test, release]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts/

      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸŽ‰ VPN Sentinel CI/CD Pipeline Summary
          
          ## âœ… Pipeline Stages
          
          | Stage | Status |
          |-------|--------|
          | ðŸ” Lint & Style | ${{ needs.lint.result }} |
          | ðŸ§ª Unit Tests | ${{ needs.test.result }} |
          | ðŸ”— Integration Tests | ${{ needs.integration-test.result }} |
          | ðŸ—ï¸ Build | ${{ needs.build.result }} |
          | ðŸ“ Validate Descriptions | ${{ needs.validate-short-description.result }} |
          | ðŸ³ Docker Test Build | ${{ needs.docker-test.result }} |
          | ðŸš€ Docker Publish | ${{ needs.docker-publish.result }} |
          | ðŸ” Security Scan | ${{ needs.security-scan.result }} |
          | ðŸš€ Deployment Test | ${{ needs.deployment-test.result }} |
          | ðŸ·ï¸ Release | ${{ needs.release.result }} |
          
          ## ðŸ³ Docker Images
          
          ### Published Images
          - **Server**: `agigante80/vpn-sentinel-server:latest`
          - **Client**: `agigante80/vpn-sentinel-client:latest`
          
          ### Registries
          - ðŸ³ [Docker Hub](https://hub.docker.com/u/agigante80)
          - ðŸ™ [GitHub Container Registry](https://github.com/orgs/${{ github.repository_owner }}/packages)
          
          ## ðŸ” Security
          
          - âœ… Vulnerability scans completed
          - âœ… SARIF reports uploaded to Security tab
          - âœ… Dependency checks passed
          
          ## ðŸ“ Descriptions
          
          - âœ… Short descriptions validated (â‰¤100 chars)
          - âœ… Long descriptions include GitHub links
          - âœ… Docker Hub descriptions updated
          
          ## ðŸ”— Quick Links
          
          - [ðŸ“¦ Releases](https://github.com/${{ github.repository }}/releases)
          - [ðŸ›¡ï¸ Security](https://github.com/${{ github.repository }}/security)
          - [ðŸ“Š Actions](https://github.com/${{ github.repository }}/actions)
          - [ðŸ“š Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          ---
          
          **Workflow run**: ${{ github.run_number }} | **Commit**: \`${{ github.sha }}\`
          EOF
          
          echo "âœ… Summary generated"
