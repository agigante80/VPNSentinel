name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - development
      - 'release/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - development
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (major, minor, patch, or skip for no release)'
        required: false
        default: 'skip'
        type: choice
        options:
          - skip
          - patch
          - minor
          - major
      release_notes:
        description: 'Optional release notes'
        required: false
        type: string

permissions:
  contents: write
  packages: write
  security-events: write
  pull-requests: write

jobs:
  # ============================================================================
  # Stage 1: Generate Dynamic Version
  # ============================================================================
  version:
    name: Generate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit_hash: ${{ steps.version.outputs.commit_hash }}
      is_release: ${{ steps.version.outputs.is_release }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Required for full Git history and tags

      - name: Generate dynamic version
        id: version
        run: |
          # Make script executable
          chmod +x get_version.sh
          
          # Generate version
          VERSION=$(bash get_version.sh)
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          # Determine if this is a release (tagged or main branch)
          if [[ "$GITHUB_REF" == "refs/heads/main" ]] && git describe --exact-match --tags HEAD 2>/dev/null; then
            IS_RELEASE="true"
          else
            IS_RELEASE="false"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸ”– Commit: $COMMIT_HASH"
          echo "ðŸš€ Release: $IS_RELEASE"

  # ============================================================================
  # Stage 2: Code Quality & Linting
  # ============================================================================
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint

      - name: Run flake8
        continue-on-error: true
        run: |
          echo "Running flake8..."
          flake8 vpn-sentinel-server/ vpn_sentinel_common/ \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --exclude=__pycache__,*.pyc,venv,htmlcov,.git

      - name: Run pylint
        continue-on-error: true
        run: |
          echo "Running pylint..."
          pylint vpn_sentinel_common/ || true

  # ============================================================================
  # Stage 3: Unit Testing
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: version
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r tests/requirements.txt

      - name: Run unit tests
        run: |
          python -m pytest tests/unit/ \
            --verbose \
            --tb=short \
            --color=yes \
            --junitxml=test-results.xml \
            --cov=vpn_sentinel_common \
            --cov-report=xml \
            --cov-report=term

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results.xml
          retention-days: 7

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7

  # ============================================================================
  # Stage 4: Docker Test Build (Validation)
  # ============================================================================
  docker-test-build:
    name: Docker Test Build
    runs-on: ubuntu-latest
    needs: [version, test]
    strategy:
      matrix:
        component:
          - name: server
            context: .
            dockerfile: vpn-sentinel-server/Dockerfile
          - name: client
            context: .
            dockerfile: vpn-sentinel-client/Dockerfile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test build ${{ matrix.component.name }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.component.context }}
          file: ${{ matrix.component.dockerfile }}
          push: false
          load: true
          tags: vpn-sentinel-${{ matrix.component.name }}:test
          build-args: |
            VERSION=${{ needs.version.outputs.version }}
            COMMIT_HASH=${{ needs.version.outputs.commit_hash }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Inspect image
        run: |
          docker images vpn-sentinel-${{ matrix.component.name }}:test
          echo "ðŸ“Š Image size: $(docker inspect vpn-sentinel-${{ matrix.component.name }}:test --format='{{.Size}}' | numfmt --to=iec)"
          echo "ðŸ·ï¸  Version: $(docker inspect vpn-sentinel-${{ matrix.component.name }}:test --format='{{.Config.Env}}' | grep -oP 'VERSION=\K[^ ]+')"

  # ============================================================================
  # Stage 5: Security Scanning
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [version, docker-test-build]
    strategy:
      matrix:
        component: [server, client]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image for scanning
        uses: docker/build-push-action@v6
        with:
          context: .
          file: vpn-sentinel-${{ matrix.component }}/Dockerfile
          push: false
          load: true
          tags: vpn-sentinel-${{ matrix.component }}:scan
          build-args: |
            VERSION=${{ needs.version.outputs.version }}
            COMMIT_HASH=${{ needs.version.outputs.commit_hash }}
          cache-from: type=gha

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: vpn-sentinel-${{ matrix.component }}:scan
          format: 'sarif'
          output: 'trivy-results-${{ matrix.component }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-results-${{ matrix.component }}.sarif'
          category: 'trivy-${{ matrix.component }}'

      - name: Run Trivy in table format
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: vpn-sentinel-${{ matrix.component }}:scan
          format: 'table'
          severity: 'CRITICAL,HIGH,MEDIUM'

  # ============================================================================
  # Stage 6: Docker Build & Publish
  # ============================================================================
  docker-publish:
    name: Build & Publish Docker Images
    runs-on: ubuntu-latest
    needs: [version, test, docker-test-build, security-scan]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development')
    strategy:
      matrix:
        component:
          - name: server
            context: .
            dockerfile: vpn-sentinel-server/Dockerfile
            dockerhub_repo: agigante80/vpn-sentinel-server
          - name: client
            context: .
            dockerfile: vpn-sentinel-client/Dockerfile
            dockerhub_repo: agigante80/vpn-sentinel-client
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Docker tags
        id: tags
        run: |
          VERSION="${{ needs.version.outputs.version }}"
          DOCKERHUB_REPO="${{ matrix.component.dockerhub_repo }}"
          GHCR_REPO="ghcr.io/${{ github.repository_owner }}/vpn-sentinel-${{ matrix.component.name }}"
          
          # Base tags
          TAGS="${DOCKERHUB_REPO}:${VERSION},${GHCR_REPO}:${VERSION}"
          
          # Add latest tag for main branch stable releases
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ needs.version.outputs.is_release }}" == "true" ]]; then
            TAGS="${TAGS},${DOCKERHUB_REPO}:latest,${GHCR_REPO}:latest"
          fi
          
          # Add development tag for development branch
          if [[ "${{ github.ref }}" == "refs/heads/development" ]]; then
            TAGS="${TAGS},${DOCKERHUB_REPO}:development,${GHCR_REPO}:development"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸  Tags: ${TAGS}"

      - name: Build and push ${{ matrix.component.name }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.component.context }}
          file: ${{ matrix.component.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
          build-args: |
            VERSION=${{ needs.version.outputs.version }}
            COMMIT_HASH=${{ needs.version.outputs.commit_hash }}
          labels: |
            org.opencontainers.image.title=VPN Sentinel ${{ matrix.component.name }}
            org.opencontainers.image.description=VPN monitoring and sentinel ${{ matrix.component.name }} component
            org.opencontainers.image.version=${{ needs.version.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Stage 7: Update Docker Hub Descriptions
  # ============================================================================
  update-dockerhub-descriptions:
    name: Update Docker Hub Descriptions
    runs-on: ubuntu-latest
    needs: [version, docker-publish]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        component:
          - name: server
            repo: agigante80/vpn-sentinel-server
            description_file: dockerhub/server_docker-repository-overview.md
            short_description_file: dockerhub/server_docker-repository-short.txt
          - name: client
            repo: agigante80/vpn-sentinel-client
            description_file: dockerhub/client_docker-repository-overview.md
            short_description_file: dockerhub/client_docker-repository-short.txt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate short description length
        run: |
          SHORT_DESC=$(cat "${{ matrix.component.short_description_file }}")
          LENGTH=${#SHORT_DESC}
          echo "ðŸ“ Short description length: $LENGTH characters"
          
          if [ $LENGTH -gt 100 ]; then
            echo "âŒ ERROR: Short description exceeds 100 characters (has $LENGTH)"
            exit 1
          fi
          
          echo "âœ… Short description length is valid"

      - name: Update Docker Hub description
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ matrix.component.repo }}
          readme-filepath: ${{ matrix.component.description_file }}
          short-description: ${{ matrix.component.short_description_file }}

  # ============================================================================
  # Stage 8: GitHub Release
  # ============================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version, docker-publish]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && needs.version.outputs.is_release == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, generating full changelog"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            echo "Generating changelog since $PREVIOUS_TAG"
            CHANGELOG=$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          # Save to file for multiline output
          echo "$CHANGELOG" > changelog.txt
          
          echo "ðŸ“ Changelog generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Release v${{ needs.version.outputs.version }}
          body_path: changelog.txt
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # Stage 9: Integration Testing (Post-Deployment)
  # ============================================================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [version, docker-publish]
    if: github.event_name == 'push' && github.ref == 'refs/heads/development'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install -r tests/requirements.txt

      - name: Start test environment
        run: |
          docker compose -f tests/docker-compose.test.yaml up -d
          sleep 10

      - name: Run integration tests
        run: |
          python -m pytest tests/integration/ \
            --verbose \
            --tb=short \
            --color=yes

      - name: Stop test environment
        if: always()
        run: |
          docker compose -f tests/docker-compose.test.yaml down -v

  # ============================================================================
  # Summary Job
  # ============================================================================
  pipeline-summary:
    name: Pipeline Summary
    runs-on: ubuntu-latest
    needs: [version, lint, test, docker-test-build, security-scan]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ needs.version.outputs.commit_hash }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Results" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: \`${{ needs.lint.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Test: \`${{ needs.test.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Test Build: \`${{ needs.docker-test-build.result }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: \`${{ needs.security-scan.result }}\`" >> $GITHUB_STEP_SUMMARY
