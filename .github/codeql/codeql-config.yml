# CodeQL Configuration for VPN Sentinel
# Documentation: https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning

name: "VPN Sentinel CodeQL Config"

# Paths to exclude from all CodeQL scanning
# These directories contain non-production code that doesn't require security analysis
paths-ignore:
  - tests/**              # All test files and directories
  - '**/__pycache__/**'   # Python bytecode cache
  - '**/htmlcov/**'       # Coverage report HTML
  - '**/node_modules/**'  # Node.js dependencies (if any)
  - '**/venv/**'          # Virtual environment
  - '**/.venv/**'         # Alternative venv location

# Query suites to run
# Using both security-extended and security-and-quality for comprehensive coverage
queries:
  - uses: security-extended
  - uses: security-and-quality

# Query filters to suppress specific false positives
# These rules are disabled for test code where the flagged patterns are intentional
query-filters:
  # ============================================================================
  # Rule: py/incomplete-url-substring-sanitization
  # Severity: Warning
  # Status: 11 open alerts (all in test files)
  # ============================================================================
  # 
  # What CodeQL flags:
  #   Using substring checks like 'domain.com' in url for URL validation
  #
  # Example of flagged pattern:
  #   if 'ipinfo.io' in url:
  #       return mock_response
  #
  # Why this is flagged as a security issue:
  #   In production code, this pattern could allow URL injection attacks:
  #     ✗ 'ipinfo.io' in 'https://evil.com/ipinfo.io/malicious'  # Returns True!
  #     ✓ urlparse(url).netloc == 'ipinfo.io'                     # Proper validation
  #
  # Why it's safe in test code:
  #   1. No user input - tests use hardcoded strings in mock handlers
  #   2. Controlled environment - runs in isolated CI/CD pipeline
  #   3. Mock responses - no actual HTTP calls or URL validation
  #   4. Test assertions - checking which API endpoint was called
  #   5. No security impact - test harness patterns only
  #
  # Example from tests/unit/test_server_info.py (line 36):
  #   ```python
  #   @patch('vpn_sentinel_common.server_info.requests.get')
  #   def test_fallback_to_ipify(self, mock_get):
  #       def mock_responses(url, **kwargs):
  #           if 'ipinfo.io' in url:      # ← Flagged by CodeQL (Alert #14)
  #               raise Exception("ipinfo.io failed")
  #           elif 'ipify.org' in url:    # ← Flagged by CodeQL (Alert #15)
  #               mock_resp = MagicMock()
  #               mock_resp.json.return_value = {'ip': '1.2.3.4'}
  #               return mock_resp
  #       mock_get.side_effect = mock_responses
  #   ```
  #
  # Why this pattern is appropriate for tests:
  #   - Tests simulate API failover between ipinfo.io → ipify.org
  #   - Mock handler needs to detect which service is being called
  #   - Substring check is intentional for test setup
  #   - No actual URL parsing needed (mocked responses)
  #
  # Production code comparison:
  #   ✅ Production: Uses requests.get(HARDCODED_URL) - no substring validation
  #   ✅ Production: URLs are constants, not constructed from user input
  #   ✅ Tests: False positives - mock patterns mimicking real API calls
  #
  # Affected files (11 alerts total):
  #   - tests/integration/test_dashboard.py (1 alert, line 85)
  #   - tests/unit/test_geolocation.py (4 alerts, lines 243, 245, 326, 328)
  #   - tests/unit/test_server_info.py (6 alerts, lines 36, 38, 118, 122, 226, 230)
  #
  # Decision rationale:
  #   ✅ Suppress in tests - False positives, no security risk
  #   ✅ Keep enabled for production code - Catch real vulnerabilities
  #   ✅ Alternative approaches considered but rejected:
  #      - Update tests to use urlparse(): More verbose, no benefit
  #      - Add nosec comments: Clutters 11+ test locations
  #      - Exclude tests from CodeQL: ✓ CHOSEN - Clean solution
  #
  - exclude:
      id: py/incomplete-url-substring-sanitization
      paths:
        - tests/**

  # ============================================================================
  # Rule: py/stack-trace-exposure
  # Severity: Error
  # Status: Fixed in production, acceptable in tests
  # ============================================================================
  #
  # What CodeQL flags:
  #   Exception stack traces exposed to users (information disclosure)
  #
  # Why this is flagged as a security issue:
  #   Stack traces can reveal:
  #     - Internal file paths and directory structure
  #     - Library versions (helpful for targeted attacks)
  #     - Database queries or internal logic
  #     - Developer comments in code
  #
  # Why it's acceptable in test code:
  #   1. Tests run in isolated CI/CD environment
  #   2. Stack traces help debug test failures
  #   3. No external users see test output
  #   4. Detailed errors speed up development
  #
  # Example acceptable pattern in tests:
  #   ```python
  #   def test_error_handling():
  #       with pytest.raises(Exception) as exc_info:
  #           function_under_test()
  #       print(exc_info.value)  # Full stack trace for debugging
  #       assert "expected error" in str(exc_info.value)
  #   ```
  #
  # Production code status:
  #   ✅ Alert #20 (Nov 15): Fixed in vpn_sentinel_common/dashboard_routes.py
  #   ✅ Alert #6 (Oct 29): Fixed in vpn-sentinel-server/vpn-sentinel-server.py
  #   ✅ Alerts #1-2 (Oct 15): Fixed in server
  #   ✅ Production uses generic error messages, logs detailed errors server-side
  #
  # Decision rationale:
  #   ✅ Suppress in tests - Detailed errors improve developer experience
  #   ✅ Keep enabled for production - Prevent information disclosure
  #
  - exclude:
      id: py/stack-trace-exposure
      paths:
        - tests/**

# ============================================================================
# CodeQL Query Packs
# ============================================================================
# Using official Python query packs from GitHub
packs:
  - codeql/python-queries

# ============================================================================
# Configuration History
# ============================================================================
#
# 2024-10-15: Initial CodeQL setup
#   - Discovered 3 stack-trace-exposure alerts in production code
#   - Discovered 1 overly-large-range alert
#
# 2024-10-29: Fixed production alerts
#   - Alert #6: Stack trace exposure in server - FIXED
#   - Alerts #4-5: Missing workflow permissions - FIXED
#
# 2024-11-10: pip CVE-2025-8869 alerts
#   - Alerts #7-8: pip symlink extraction vulnerability
#   - Resolution: Upgraded to pip 25.3+ (fixed in Dockerfile)
#   - Status: Dismissed (resolved)
#
# 2024-11-12: Test file alerts appeared
#   - 11 new py/incomplete-url-substring-sanitization alerts
#   - All in test files using mock URL patterns
#   - No production code affected
#
# 2024-11-15: Dashboard stack trace fixed
#   - Alert #20: Stack trace exposure in dashboard - FIXED
#
# 2024-12-16: CodeQL configuration enhanced
#   - Added comprehensive documentation for suppressed rules
#   - Formalized decision to exclude tests from URL validation
#   - Documented rationale with examples and security assessment
#
# Current status:
#   ✅ 0 open alerts in production code
#   ✅ 11 suppressed alerts in test code (false positives)
#   ✅ All historical production alerts fixed
#   ✅ Security scanning: Clean and well-configured
#
# ============================================================================
# Maintenance Notes
# ============================================================================
#
# When to review this configuration:
#   1. New CodeQL rules released - Evaluate if test exclusions needed
#   2. Production alerts appear - Fix immediately, don't suppress
#   3. Test patterns change - Update documentation if needed
#   4. Annual security review - Validate exclusions still appropriate
#
# How to test this configuration locally:
#   # CodeQL requires GitHub Actions or CLI tool
#   gh api repos/agigante80/VPNSentinel/code-scanning/alerts
#
# References:
#   - CodeQL Documentation: https://codeql.github.com/docs/
#   - Python Query Reference: https://codeql.github.com/codeql-query-help/python/
#   - VPN Sentinel Alerts: https://github.com/agigante80/VPNSentinel/security/code-scanning
#   - Configuration Guide: https://docs.github.com/en/code-security/code-scanning/
#
# ============================================================================
