# VPN Sentinel - Docker Compose Configuration
# 
# This setup provides a comprehensive VPN monitoring and DNS leak detection system:
# - Gluetun VPN container (example - replace with your preferred VPN solution)
# - VPN Sentinel Client (monitors from inside VPN network)
# - VPN Sentinel Server (receives reports and sends Telegram notifications)
# - Dual-network architecture for reliable monitoring
#
# Prerequisites:
# 1. Copy .env.example to .env and configure your values
# 2. Ensure Docker and Docker Compose are installed  
# 3. Configure VPN provider credentials in .env file
# 4. Set up Telegram bot for notifications (highly recommended)
#
# External Access Ports:
# - VPN Sentinel API: http://YOUR_SERVER_IP:5000
#
# Key Features:
# - Real-time VPN connection monitoring with 5-minute intervals
# - DNS leak detection using Cloudflare trace endpoints
# - Instant Telegram notifications for VPN status changes
# - IP geolocation tracking and provider identification
# - Interactive bot commands (/ping, /status, /help)
# - REST API endpoints for external integration
# - Rate limiting and security features

version: "3"

services:
  # =============================================================================
  # VPN CLIENT - EXAMPLE using Gluetun (REPLACE with your preferred VPN client)
  # =============================================================================
  # 
  # üîÑ GLUETUN IS JUST AN EXAMPLE! Replace with any VPN client you prefer:
  #
  # ‚úÖ Popular VPN Client Alternatives:
  # - Gluetun: qmcgaw/gluetun (70+ providers, our example below)
  # - OpenVPN: dperson/openvpn-client (custom .ovpn files)
  # - WireGuard: linuxserver/wireguard (modern, fast protocol) 
  # - Transmission+VPN: haugene/transmission-openvpn (torrent + VPN)
  # - PIA WireGuard: thrnz/docker-wireguard-pia (PIA-specific)
  # - Any other Docker VPN solution you prefer!
  #
  # üéØ GLUETUN ADVANTAGES (why we use it as example):
  # - Supports 70+ VPN providers (NordVPN, Surfshark, ExpressVPN, etc.)
  # - Simple configuration via environment variables
  # - Built-in kill switch and health checks  
  # - Actively maintained with excellent documentation
  # - Works out-of-the-box with most VPN providers
  #
  # üîÑ TO USE A DIFFERENT VPN CLIENT:
  # 1. Replace this entire 'gluetun' service with your VPN client
  # 2. Update network_mode in 'vpn-sentinel-client' to match your container name
  # 3. VPN Sentinel will work exactly the same with any VPN client!
  #
  gluetun:
    # üìù EXAMPLE VPN CLIENT - Replace with your preferred VPN solution!
    image: qmcgaw/gluetun
    container_name: gluetun
    cap_add:
      - NET_ADMIN  # Required for VPN tunnel creation
    devices:
      - /dev/net/tun:/dev/net/tun  # TUN device for VPN tunnel
    ports:
      # Add any ports your applications need here
      # Example for a simple web service:
      # - 8080:8080  # Your application port
      pass  # No specific ports required for VPN Sentinel monitoring
    volumes:
      - ./gluetun:/gluetun  # VPN config and logs
    environment:
      # üîß GLUETUN-SPECIFIC CONFIGURATION (adapt for your VPN client):
      - UPDATER_PERIOD=${UPDATER_PERIOD:-24h}              # Gluetun: Update check interval
      - VPN_SERVICE_PROVIDER=${VPN_SERVICE_PROVIDER}       # Gluetun: Provider name
      - SERVER_COUNTRIES=${SERVER_COUNTRIES}               # Gluetun: Preferred countries
      - OPENVPN_USER=${VPN_USER}                           # Gluetun: VPN username  
      - OPENVPN_PASSWORD=${VPN_PASSWORD}                   # Gluetun: VPN password
      # üåê NETWORK CONFIGURATION (keep this for VPN Sentinel):
      - FIREWALL_OUTBOUND_SUBNETS=10.50.0.0/16,10.51.0.0/16  # Allow VPN Sentinel communication
    networks:
      - vpn-sentinel-internal  # Internal network for VPN Sentinel monitoring
    restart: always

  # =============================================================================
  # YOUR APPLICATIONS - Add your VPN-protected containers here
  # =============================================================================
  #
  # This is where you would add your applications that need VPN protection.
  # Examples of containers you might add:
  #
  # # Download client example:
  # qbittorrent:
  #   image: lscr.io/linuxserver/qbittorrent
  #   container_name: qbittorrent
  #   environment:
  #     - PUID=${PUID_MEDIA}
  #     - PGID=${PGID_MEDIA}
  #     - TZ=${TZ}
  #   volumes:
  #     - ./qbittorrent/config:/config
  #     - ./downloads:/downloads
  #   network_mode: service:gluetun  # Route through VPN
  #   depends_on:
  #     - gluetun
  #   restart: unless-stopped
  #
  # # Web application example:
  # your-web-app:
  #   image: your-app:latest
  #   container_name: your-web-app
  #   network_mode: service:gluetun  # Route through VPN
  #   depends_on:
  #     - gluetun
  #   restart: unless-stopped
  #
  # The key is using: network_mode: service:gluetun
  # This routes all traffic through the VPN container.

  # =============================================================================
  # VPN SENTINEL MONITORING SYSTEM - Real-time VPN monitoring & notifications
  # =============================================================================
  
  # VPN Sentinel Client - Monitors from INSIDE the VPN network
  # This container shares the VPN network stack and performs continuous monitoring:
  # - DNS leak detection using Cloudflare trace endpoints
  # - IP geolocation tracking and provider identification  
  # - Connection health checks every 5 minutes
  # - Reports status to the external server for Telegram notifications
  vpn-sentinel-client:
    image: curlimages/curl:latest
    container_name: vpn-sentinel-client
    environment:
      - KEEPALIVE_SERVER_URL=${KEEPALIVE_SERVER_URL:-http://vpn-sentinel-server:5000}
      - KEEPALIVE_CLIENT_ID=${KEEPALIVE_CLIENT_ID:-vpn-monitor-main}
      - KEEPALIVE_API_KEY=${KEEPALIVE_API_KEY}
      - TZ=${TZ:-UTC}
    volumes:
      - ./keepalive-client/keepalive.sh:/tmp/keepalive.sh:ro
    # =============================================================================
    # DNS Leak Testing Configuration
    # =============================================================================
    # Uncomment the dns section below to test DNS leak detection:
    # dns:
    #   - 8.8.8.8          # Google DNS (US) - will trigger leak alert
    #   - 8.8.4.4          # Google DNS (US) - will trigger leak alert
    # 
    # Other test DNS servers:
    #   - 1.1.1.1          # Cloudflare DNS (global)
    #   - 208.67.222.222    # OpenDNS (US-based)
    #   - 9.9.9.9           # Quad9 DNS (various locations)
    # =============================================================================
    network_mode: service:gluetun  # üîÑ CHANGE 'gluetun' to YOUR VPN container name!
    command: >
      sh -c "
      echo 'üöÄ VPN Sentinel Client Starting...' &&
      sleep 30 &&
      echo '‚è≥ Waiting for VPN connection to stabilize...' &&
      sleep 30 &&
      echo 'üìÅ Setting up monitoring script...' &&
      mkdir -p /home/curl_user &&
      cp /tmp/keepalive.sh /home/curl_user/keepalive.sh &&
      chmod +x /home/curl_user/keepalive.sh &&
      echo 'üîç Starting continuous VPN monitoring...' &&
      exec /home/curl_user/keepalive.sh
      "
    depends_on:
      - gluetun                  # üîÑ CHANGE 'gluetun' to YOUR VPN container name!
      - vpn-sentinel-server      # Requires monitoring server for reporting
    restart: unless-stopped

  # VPN Sentinel Server - Receives reports and sends Telegram notifications
  # This container runs on the real IP network (NOT through VPN) to ensure:
  # - Always reachable for status reports from VPN client
  # - Can send Telegram notifications even when VPN fails
  # - Provides REST API endpoints for external monitoring systems
  vpn-sentinel-server:
    image: python:3.11-alpine
    container_name: vpn-sentinel-server
    ports:
      - "${VPN_SENTINEL_PORT:-5000}:5000"  # External API access
    environment:
      # Telegram Configuration (highly recommended)
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      
      # Security & API Configuration  
      - KEEPALIVE_API_KEY=${KEEPALIVE_API_KEY}
      - MAX_REQUESTS_PER_MINUTE=${MAX_REQUESTS_PER_MINUTE:-30}
      - ALLOWED_IPS=${ALLOWED_IPS:-}  # Comma-separated IP whitelist (optional)
      
      # System Configuration
      - TZ=${TZ:-UTC}
    volumes:
      - ./keepalive-server/keepalive-server.py:/app/keepalive-server.py:ro
    working_dir: /app
    networks:
      - vpn-sentinel-isolated  # Isolated network (bypasses VPN for guaranteed access)
    command: >
      sh -c "
      echo 'üì¶ Installing VPN Sentinel Server dependencies...' &&
      pip install --no-cache-dir flask requests pytz &&
      echo 'üöÄ Starting VPN Sentinel Server...' &&
      python keepalive-server.py
      "
    restart: unless-stopped
    # Health check to ensure server is responding
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 60s
      timeout: 10s
      start_period: 30s
      retries: 3

# =============================================================================
# NETWORK CONFIGURATION - Dual-network architecture for reliable monitoring
# =============================================================================
networks:
  # Internal network for VPN container communication
  # Allows VPN Sentinel Client to communicate with the VPN container
  vpn-sentinel-internal:
    driver: bridge
    name: vpn-sentinel-internal
    ipam:
      config:
        - subnet: 10.50.0.0/16
          gateway: 10.50.0.1
    labels:
      - "vpn-sentinel.network.type=internal"
      - "vpn-sentinel.network.purpose=vpn-communication"
  
  # Isolated network for VPN Sentinel Server
  # Ensures the monitoring server can always send Telegram notifications
  # even when VPN connection fails completely
  vpn-sentinel-isolated:
    driver: bridge
    name: vpn-sentinel-isolated
    ipam:
      config:
        - subnet: 10.51.0.0/16
          gateway: 10.51.0.1
    labels:
      - "vpn-sentinel.network.type=isolated" 
      - "vpn-sentinel.network.purpose=telegram-notifications"

# =============================================================================
# VPN SENTINEL DEPLOYMENT GUIDE
# =============================================================================
#
# üöÄ Quick Start:
# 1. Copy .env.example to .env: cp .env.example .env
# 2. Edit .env with your VPN credentials and Telegram bot info
# 3. (Optional) Replace 'gluetun' with your preferred VPN client
# 4. Start the stack: docker compose up -d
# 5. Check logs: docker compose logs -f vpn-sentinel-client
# 6. Test with Telegram: Send /ping to your bot
#
# üîó Key URLs:
# - VPN Sentinel API: http://localhost:5000
# - Health Check: http://localhost:5000/health
# - Status API: http://localhost:5000/status
#
# üîÑ Replace Gluetun with your VPN client:
# 1. Replace 'gluetun' service with your VPN client configuration
# 2. Change network_mode: service:your-vpn-container-name
# 3. Update depends_on: your-vpn-container-name
# 4. VPN Sentinel will work exactly the same!
#
# üì± Telegram Commands:
# - /ping - Test connectivity
# - /status - Get VPN status  
# - /help - Show all commands
#
# üõ°Ô∏è Security Features:
# - API key authentication (set KEEPALIVE_API_KEY in .env)
# - Rate limiting (30 req/min by default)
# - IP whitelisting (set ALLOWED_IPS in .env)
#
# üîß Customization:
# - Change monitoring interval: Edit INTERVAL in keepalive.sh (default: 5min)
# - Change alert threshold: Edit ALERT_THRESHOLD_MINUTES in keepalive-server.py (default: 15min)
# - Add your applications: Use network_mode: service:gluetun
#
# =============================================================================
